#---
#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  name: keycloak-postgres-pvc
#  namespace: student-housing
#spec:
#  accessModes:
#    - ReadWriteOnce
#  resources:
#    requests:
#      storage: 1Gi
#
#---
#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: keycloak-postgres
#  namespace: student-housing
#spec:
#  replicas: 1
#  selector:
#    matchLabels:
#      app: keycloak-postgres
#  template:
#    metadata:
#      labels:
#        app: keycloak-postgres
#    spec:
#      containers:
#        - name: postgres
#          image: postgres:15-alpine
#          ports:
#            - containerPort: 5432
#          env:
#            - name: POSTGRES_DB
#              value: "keycloak"
#            - name: POSTGRES_USER
#              value: "keycloak"
#            - name: POSTGRES_PASSWORD
#              value: "keycloak123"
#          volumeMounts:
#            - name: postgres-storage
#              mountPath: /var/lib/postgresql/data
#              subPath: postgres
#          resources:
#            requests:
#              memory: "256Mi"
#              cpu: "200m"
#            limits:
#              memory: "512Mi"
#              cpu: "500m"
#          livenessProbe:
#            exec:
#              command:
#                - pg_isready
#                - -U
#                - keycloak
#            initialDelaySeconds: 30
#            periodSeconds: 10
#            timeoutSeconds: 5        # <-- ADD THIS LINE
#            failureThreshold: 3      # <-- ADD THIS LINE TOO
#          readinessProbe:
#            exec:
#              command:
#                - pg_isready
#                - -U
#                - keycloak
#            initialDelaySeconds: 10
#            periodSeconds: 5
#            timeoutSeconds: 5        # <-- ADD THIS LINE
#            failureThreshold: 3      # <-- ADD THIS LINE TOO
#      volumes:
#        - name: postgres-storage
#          persistentVolumeClaim:
#            claimName: keycloak-postgres-pvc
#
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: keycloak-postgres
#  namespace: student-housing
#spec:
#  ports:
#    - port: 5432
#  selector:
#    app: keycloak-postgres
#
#---
#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: keycloak
#  namespace: student-housing
#spec:
#  replicas: 1
#  selector:
#    matchLabels:
#      app: keycloak
#  template:
#    metadata:
#      labels:
#        app: keycloak
#    spec:
#      initContainers:
#        - name: wait-for-postgres
#          image: busybox:1.35
#          command: ['sh', '-c', 'until nc -z keycloak-postgres 5432; do echo waiting for keycloak-postgres; sleep 2; done;']
#
#      containers:
#        - name: keycloak
#          image: quay.io/keycloak/keycloak:23.0.0
#          args: ["start-dev"]
#          ports:
#            - containerPort: 8080
#          env:
#            - name: KC_DB
#              value: "postgres"
#            - name: KC_DB_URL
#              value: "jdbc:postgresql://keycloak-postgres:5432/keycloak"
#            - name: KC_DB_USERNAME
#              value: "keycloak"
#            - name: KC_DB_PASSWORD
#              value: "keycloak123"
#            - name: KC_HOSTNAME_STRICT
#              value: "false"
#            - name: KC_HOSTNAME_STRICT_HTTPS
#              value: "false"
#            - name: KC_HTTP_ENABLED
#              value: "true"
#            - name: KC_LOG_LEVEL
#              value: "info"
#            - name: KC_METRICS_ENABLED
#              value: "true"
#            - name: KC_HEALTH_ENABLED
#              value: "true"
#            - name: KEYCLOAK_ADMIN
#              value: "admin"
#            - name: KEYCLOAK_ADMIN_PASSWORD
#              value: "admin123"
#          resources:
#            requests:
#              memory: "512Mi"
#              cpu: "500m"
#            limits:
#              memory: "1Gi"
#              cpu: "1000m"
#          startupProbe:
#            httpGet:
#              path: /health/started
#              port: 8080
#            initialDelaySeconds: 60
#            periodSeconds: 10
#            failureThreshold: 30
#            timeoutSeconds: 5
#          livenessProbe:
#            httpGet:
#              path: /health/live
#              port: 8080
#            initialDelaySeconds: 10
#            periodSeconds: 15
#            failureThreshold: 5
#            timeoutSeconds: 5
#          readinessProbe:
#            httpGet:
#              path: /health/ready
#              port: 8080
#            initialDelaySeconds: 10
#            periodSeconds: 10
#            failureThreshold: 10
#            timeoutSeconds: 5
#
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: keycloak
#  namespace: student-housing
#spec:
#  type: NodePort
#  ports:
#    - name: http
#      port: 8080
#      targetPort: 8080
#      nodePort: 30090
#  selector:
#    app: keycloak
#
#

# TODO Update the deployment
# NOTE: This file does NOT touch the existing keycloak-postgres deployment
# Your data is safe!

---
## Keycloak Deployment (Development Mode)
#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: keycloak
#  namespace: student-housing
#spec:
#  replicas: 1
#  strategy:
#    type: Recreate
#  selector:
#    matchLabels:
#      app: keycloak
#  template:
#    metadata:
#      labels:
#        app: keycloak
#        version: v1
#    spec:
#      # ✅ ADDED: Init container to wait for PostgreSQL
#      initContainers:
#        - name: wait-for-postgres
#          image: busybox:1.36
#          command:
#            - sh
#            - -c
#            - |
#              echo "Waiting for Keycloak PostgreSQL to be ready..."
#              max_attempts=60
#              attempt=0
#              until nc -z keycloak-postgres.student-housing.svc.cluster.local 5432 || [ $attempt -ge $max_attempts ]; do
#                echo "PostgreSQL is unavailable - sleeping (attempt $attempt/$max_attempts)"
#                sleep 3
#                attempt=$((attempt + 1))
#              done
#              if [ $attempt -ge $max_attempts ]; then
#                echo "ERROR: PostgreSQL not ready after $max_attempts attempts"
#                exit 1
#              fi
#              echo "PostgreSQL is up - waiting 10 seconds for full initialization"
#              sleep 10
#              echo "PostgreSQL ready!"
#          resources:
#            limits:
#              cpu: 50m
#              memory: 64Mi
#            requests:
#              cpu: 10m
#              memory: 32Mi
#
#      containers:
#        - name: keycloak
#          image: quay.io/keycloak/keycloak:23.0.0
#          args: ["start-dev"]
#          ports:
#            - containerPort: 8080
#              name: http
#          env:
#            # ✅ FIXED: Use service name instead of hardcoded Pod IP (10.244.7.7)
#            - name: KC_DB
#              value: "postgres"
#            - name: KC_DB_URL
#              value: "jdbc:postgresql://keycloak-postgres.student-housing.svc.cluster.local:5432/keycloak?connectTimeout=30"
#            - name: KC_DB_USERNAME
#              value: "keycloak"
#            - name: KC_DB_PASSWORD
#              value: "keycloak123"
#            - name: KC_DB_POOL_INITIAL_SIZE
#              value: "5"
#            - name: KC_DB_POOL_MIN_SIZE
#              value: "5"
#            - name: KC_DB_POOL_MAX_SIZE
#              value: "20"
#            - name: KC_HOSTNAME_STRICT
#              value: "false"
#            - name: KC_HOSTNAME_STRICT_HTTPS
#              value: "false"
#            - name: KC_HTTP_ENABLED
#              value: "true"
#            - name: KC_HEALTH_ENABLED
#              value: "true"
#            - name: KEYCLOAK_ADMIN
#              value: "admin"
#            - name: KEYCLOAK_ADMIN_PASSWORD
#              value: "admin123"
#            - name: JAVA_OPTS_APPEND
#              value: "-Xms512m -Xmx1024m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m"
#            - name: KC_LOG_LEVEL
#              value: "INFO"
#          resources:
#            requests:
#              memory: "1Gi"
#              cpu: "500m"
#            limits:
#              memory: "2Gi"
#              cpu: "1500m"
#          # ✅ IMPROVED: More lenient probes
#          startupProbe:
#            httpGet:
#              path: /health/started
#              port: 8080
#            initialDelaySeconds: 90
#            periodSeconds: 10
#            failureThreshold: 60
#            timeoutSeconds: 5
#          livenessProbe:
#            httpGet:
#              path: /health/live
#              port: 8080
#            initialDelaySeconds: 180
#            periodSeconds: 30
#            failureThreshold: 5
#            timeoutSeconds: 5
#          readinessProbe:
#            httpGet:
#              path: /health/ready
#              port: 8080
#            initialDelaySeconds: 90
#            periodSeconds: 10
#            failureThreshold: 10
#            timeoutSeconds: 5
#
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: keycloak
#  namespace: student-housing
#spec:
#  type: ClusterIP
#  selector:
#    app: keycloak
#  ports:
#    - name: http
#      protocol: TCP
#      port: 8080
#      targetPort: 8080
#
#---
## NodePort service for external access
#apiVersion: v1
#kind: Service
#metadata:
#  name: keycloak-nodeport
#  namespace: student-housing
#spec:
#  type: NodePort
#  selector:
#    app: keycloak
#  ports:
#    - name: http
#      protocol: TCP
#      port: 8080
#      targetPort: 8080
#      nodePort: 30080



#TODO NEW UPDATE KEYCLOAK DEPLOYMENT
# ==========================================
# COMPLETE KEYCLOAK + POSTGRESQL DEPLOYMENT
# All issues fixed - Copy this entire file
# ==========================================

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: keycloak-postgres-pvc
  namespace: student-housing
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# PostgreSQL Deployment - FIXED PROBES
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak-postgres
  namespace: student-housing
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: keycloak-postgres
  template:
    metadata:
      labels:
        app: keycloak-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
              name: postgres
          env:
            - name: POSTGRES_DB
              value: "keycloak"
            - name: POSTGRES_USER
              value: "keycloak"
            - name: POSTGRES_PASSWORD
              value: "keycloak123"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          # FIXED PROBES - Correct command format and longer timeouts
          startupProbe:
            exec:
              command:
                - sh
                - -c
                - pg_isready -U keycloak
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 30

          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - pg_isready -U keycloak
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 6

          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - pg_isready -U keycloak
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 6
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: keycloak-postgres-pvc

---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: keycloak-postgres
  namespace: student-housing
spec:
  type: ClusterIP
  selector:
    app: keycloak-postgres
  ports:
    - name: postgres
      protocol: TCP
      port: 5432
      targetPort: 5432

---
# Keycloak Deployment - COMPLETE WITH INIT CONTAINER
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: student-housing
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      # Init container - Waits for PostgreSQL to be ready
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              until nc -z keycloak-postgres.student-housing.svc.cluster.local 5432; do
                echo "PostgreSQL is unavailable - sleeping"
                sleep 2
              done
              echo "PostgreSQL is ready!"
              sleep 5
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"

      containers:
        - name: keycloak
          image: quay.io/keycloak/keycloak:22.0.5
          args:
            - "start-dev"
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            # Database Configuration
            - name: KC_DB
              value: "postgres"
            - name: KC_DB_URL
              value: "jdbc:postgresql://keycloak-postgres.student-housing.svc.cluster.local:5432/keycloak"
            - name: KC_DB_USERNAME
              value: "keycloak"
            - name: KC_DB_PASSWORD
              value: "keycloak123"

            # Hostname Configuration
            - name: KC_HOSTNAME_STRICT
              value: "false"
            - name: KC_HOSTNAME_STRICT_HTTPS
              value: "false"
            - name: KC_HTTP_ENABLED
              value: "true"

            # Admin Credentials
            - name: KEYCLOAK_ADMIN
              value: "admin"
            - name: KEYCLOAK_ADMIN_PASSWORD
              value: "admin123"

            # Proxy Settings
            - name: KC_PROXY
              value: "edge"

            # Database Connection Pool Settings
            - name: KC_DB_POOL_INITIAL_SIZE
              value: "5"
            - name: KC_DB_POOL_MIN_SIZE
              value: "5"
            - name: KC_DB_POOL_MAX_SIZE
              value: "20"

            # Health checks
            - name: KC_HEALTH_ENABLED
              value: "true"

            # Java Options - Increased for stable startup
            - name: JAVA_OPTS
              value: "-Xms512m -Xmx1024m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m"

          resources:
            requests:
              memory: "768Mi"
              cpu: "500m"
            limits:
              memory: "1536Mi"
              cpu: "1500m"

          # Startup probe - Very generous timing for first startup
          startupProbe:
            httpGet:
              path: /health/ready
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 60  # 60 * 15 = 15 minutes max startup time
            timeoutSeconds: 10

          # Liveness probe - Only checks after startup succeeds
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
            initialDelaySeconds: 0  # Startup probe handles initial delay
            periodSeconds: 30
            failureThreshold: 5
            timeoutSeconds: 10

          # Readiness probe - Checks if ready to serve traffic
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8080
            initialDelaySeconds: 0
            periodSeconds: 10
            failureThreshold: 10
            timeoutSeconds: 5

---
# Keycloak Service
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: student-housing
spec:
  type: ClusterIP
  selector:
    app: keycloak
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080

---
# Keycloak NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: keycloak-nodeport
  namespace: student-housing
spec:
  type: NodePort
  selector:
    app: keycloak
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 30080
